
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Github单文件编辑器</title>
  <style>
    * {  margin: 0; padding: 0; box-sizing: border-box;  }
    #code-editor { width: 100dvw; height: 100dvh; line-height: 1.4; }
    .tools{ position: fixed; top: 2px; right: 8px; font-size: 14px; display: flex; gap: 6px; z-index: 9; }
    .tools i, .tools select{ background: #fff;  border: 1px solid #dcdfe6; padding: 3px 4px; font-style: normal; cursor: pointer; }
    #formatRef { display: none; } .mode-json #formatRef { display: block; } .mode-json #runRef { display: none; }
  </style>
</head>
<body id="bodyRef">
  <div id="code-editor"></div>
  <div class="tools">
    <select id="modeRef"></select><i id="tokenRef">设置Token</i><i id="fileRef">设置文件</i>
    <i id="saveRef">保存</i><i id="runRef">运行</i><i id="formatRef">格式化</i>
  </div>
  <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/ace/1.43.2/ace.min.js"></script>
  <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/ace/1.43.2/ext-language_tools.min.js"></script>
  <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/axios/1.11.0/axios.min.js"></script>
  <script src="js/theme-vscode-dark.js"></script>
  <script>
    modeRef.innerHTML = ['html', 'json', 'javascript'].map(v => `<option value="${v}">${v}</option>`).join('');
    function changeMode() { editor.session.setMode('ace/mode/' + modeRef.value); bodyRef.className = 'mode-' + modeRef.value; }
    modeRef.onchange = changeMode
    runRef.onclick = function () { window.open(URL.createObjectURL(new Blob([editor.getValue()], { type: `text/${modeRef.value};charset=utf-8` }))) }
    formatRef.onclick = function () { editor.setValue(JSON.stringify(JSON.parse(editor.getValue()), null, 2)) }
    // ace.require('ace/ext/language_tools');
    var editor = ace.edit('code-editor', {
      theme: 'ace/theme/vscode-dark', // 主题 ace/theme/chrome
      mode: 'ace/mode/html', // 代码匹配模式
      tabSize: 2, //标签大小
      fontSize: 14, //设置字号
      enableSnippets: true, // 启用代码段
      showLineNumbers: true, // 显示行号
      enableLiveAutocompletion: true, // 启用实时自动完成功能 （比如：智能代码提示）
      enableBasicAutocompletion: true, // 启用基本自动完成功能
      keyboardHandler: 'ace/keyboard/vscode',
    });
    // editor.setValue(this.svgCode);
    editor.session.on('change', () => { console.log('editor change...', editor.getValue()) });
    editor.commands.addCommand({ name: 'save', bindKey: {win: 'Ctrl-S', mac: 'Command-S'}, exec: () => console.log('save')})

    window.gitToken = substr(localStorage.getItem('gitToken') || '')
    window.gitFile = localStorage.getItem('gitFile')
    window.repoFile = (gitFile || '|').split('|')

    tokenRef.onclick = function () {
      const temp = prompt('请输入GitHub Token: ', gitToken)
      if (!temp) return
      localStorage.setItem('gitToken', addstr(temp.trim())); location.reload()
    }
    fileRef.onclick = function () {
      const temp = prompt('请输入编辑文件, 格式: user/repo|file, 比如dhjz/tv|index.html: ', gitFile)
      if (!temp) return
      if (temp.split('|').length != 2) return alert('请输入正确格式, user/repo|file, 仓库和路径文件之间用"|"分隔')
      localStorage.setItem('gitFile', temp); location.reload()
    }

    window.requestGit = axios.create({ baseURL: 'https://api.github.com/', timeout: 10000, headers: {
      'Authorization': 'Bearer ' + gitToken, 
      'Accept': 'application/vnd.github+json', 
      'X-GitHub-Api-Version': '2022-11-28'
    }})

    window.gitUtils = {
      getSha() {
        return new Promise((reso) => {
          requestGit.get(`/repos/${repoFile[0]}/contents/${repoFile[1]}`).then(res => reso(res.data.sha)).catch(() => reso(null))
        })
      },
      getContent(isResp) {
        if (isResp) return requestGit.get(`/repos/${repoFile[0]}/contents/${repoFile[1]}`)

        return new Promise((reso, rej) => {
          requestGit.get(`/repos/${repoFile[0]}/contents/${repoFile[1]}`).then(res => {
            if (Array.isArray(res.data)) return reso(res.data)
            reso(decode64(res.data.content))
          }).catch(() => {
            console.log('not exit file: ' + repoFile[1])
            reso(null)
          })
        })
      },
      putContent(content) {
        const data = { message: 'update ' + repoFile[1], content: encode64(content) }
        return this.getSha(repoFile[1]).then(sha => {
          if (sha) data.sha = sha
          return requestGit.put(`/repos/${repoFile[0]}/contents/${repoFile[1]}`, data)
        })
      }
    }

    function addstr(str) {
      return str.substring(0, 16) + Math.random().toString(32).slice(-6) + str.substring(16)
    }

    function substr(str) {
      return str.substring(0, 16) + str.substring(16 + 6)
    }

    function encode64(str) {
      return btoa(new TextEncoder().encode(str).reduce((r, byte) => r + String.fromCharCode(byte), ''))
    }

    function decode64(str) {
      return new TextDecoder().decode(Uint8Array.from(atob(str), c => c.charCodeAt(0)))
    }

    !function onMounted() {
      saveRef.onclick = function () {
        if (!repoFile[0] || !repoFile[1] || !localStorage.getItem('gitToken')) return alert('请先设置GitHub Token和文件')
        if (!editor.getValue().trim()) return alert('请输入内容')
        gitUtils.putContent(editor.getValue()).then(() => alert('保存成功'))
      }
      if (!repoFile[0] || !repoFile[1] || !localStorage.getItem('gitToken')) return
      gitUtils.getContent().then(data => {
        if (data !== null) {
          repoFile[1].endsWith('.json') && (modeRef.value = 'json', changeMode())
          repoFile[1].endsWith('.js') && (modeRef.value = 'javascript', changeMode())
          editor.setValue(data)
        } else {
          gitUtils.putContent('')
        }
      })
    }()

  </script>
</body>
</html>